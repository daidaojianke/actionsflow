# 通过 Github action， 定期或手动 merge remote 仓库
# 1. 设定 schedule
# 2. 添加 Secrets: REMOTE_REPO_URL
# 3. 检查 Action 的免费时长是否充足
name: merge-remote
on:
  schedule:
    - cron:  '0 1 * * *'
  workflow_dispatch:

  jobs:
    build:

      name: Merge remote repo
      env:
        repo_url: ${{ secrets.REMOTE_REPO_URL }}
      runs-on: ubuntu-latest
      steps:
        - name: Checkout
          uses: actions/checkout@v2
          with:
            persist-credentials: false

        - name: Setup git config
          if: env.repo_url
          run: |
            # setup the username and email. I tend to use 'GitHub Actions Bot' with no email by default
            git config --global user.name 'Github Actions Bot'
            git config --global user.email '<>'

        - name: Merge upstream
          if: env.repo_url
          run: |
            git pull --unshallow
            git remote add upstream '${{ secrets.REMOTE_REPO_URL }}'
            git fetch upstream
            git checkout master
            git merge --no-edit upstream/master --allow-unrelated-histories

        - name: Commit
          if: env.repo_url
          run: |
            git add .
            git commit -m ":repeat: Sync from '${{ secrets.REMOTE_REPO_URL }}'"
            git push origin master
